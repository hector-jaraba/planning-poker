(()=>{var e={};e.id=899,e.ids=[899],e.modules={72934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},55403:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external")},54580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},94749:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external")},45869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},14300:e=>{"use strict";e.exports=require("buffer")},32081:e=>{"use strict";e.exports=require("child_process")},6113:e=>{"use strict";e.exports=require("crypto")},82361:e=>{"use strict";e.exports=require("events")},57147:e=>{"use strict";e.exports=require("fs")},13685:e=>{"use strict";e.exports=require("http")},95687:e=>{"use strict";e.exports=require("https")},41808:e=>{"use strict";e.exports=require("net")},22037:e=>{"use strict";e.exports=require("os")},71017:e=>{"use strict";e.exports=require("path")},12781:e=>{"use strict";e.exports=require("stream")},24404:e=>{"use strict";e.exports=require("tls")},76224:e=>{"use strict";e.exports=require("tty")},57310:e=>{"use strict";e.exports=require("url")},73837:e=>{"use strict";e.exports=require("util")},59796:e=>{"use strict";e.exports=require("zlib")},54939:(e,t,s)=>{"use strict";s.r(t),s.d(t,{GlobalError:()=>r.a,__next_app__:()=>u,originalPathname:()=>m,pages:()=>c,routeModule:()=>g,tree:()=>d});var a=s(67096),i=s(16132),n=s(37284),r=s.n(n),o=s(32564),l={};for(let e in o)0>["default","tree","pages","GlobalError","originalPathname","__next_app__","routeModule"].indexOf(e)&&(l[e]=()=>o[e]);s.d(t,l);let d=["",{children:["sessions",{children:["[id]",{children:["__PAGE__",{},{page:[()=>Promise.resolve().then(s.bind(s,71046)),"/Users/hector.jaraba/Proyects/cursor-planning-poker/src/app/sessions/[id]/page.tsx"]}]},{}]},{}]},{layout:[()=>Promise.resolve().then(s.bind(s,7389)),"/Users/hector.jaraba/Proyects/cursor-planning-poker/src/app/layout.tsx"],"not-found":[()=>Promise.resolve().then(s.t.bind(s,9291,23)),"next/dist/client/components/not-found-error"]}],c=["/Users/hector.jaraba/Proyects/cursor-planning-poker/src/app/sessions/[id]/page.tsx"],m="/sessions/[id]/page",u={require:s,loadChunk:()=>Promise.resolve()},g=new a.AppPageRouteModule({definition:{kind:i.x.APP_PAGE,page:"/sessions/[id]/page",pathname:"/sessions/[id]",bundlePath:"",filename:"",appPaths:[]},userland:{loaderTree:d}})},95136:(e,t,s)=>{Promise.resolve().then(s.bind(s,59726))},59726:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>SessionPage});var a=s(30784),i=s(9885),n=s(57114),r=s(74284),o=s(90304),l=s(56641);function EstimationCard({value:e,selected:t,onClick:s}){return a.jsx("button",{className:`flex h-16 w-12 items-center justify-center rounded-md text-xl font-bold transition-colors duration-200 sm:h-20 sm:w-16 ${t?"bg-primary-600 text-white":"bg-gray-700 text-gray-200 hover:bg-gray-600"}`,onClick:t=>{console.log("Estimation card clicked:",e),t.preventDefault(),s()},children:e})}function TaskList({tasks:e,activeTaskId:t,setActiveTask:s,isAdmin:i}){return 0===e.length?a.jsx("p",{className:"text-gray-400",children:"No tasks available."}):(console.log("All tasks in TaskList:",e.map(e=>({id:e.id||e._id,title:e.title}))),a.jsx("div",{className:"space-y-2",children:e.map(e=>{let i=e.id||e._id;return e&&i?(console.log("Rendering task:",{id:i,title:e.title,status:e.status}),(0,a.jsxs)("div",{className:`cursor-pointer rounded-md p-3 ${i===t?"bg-primary-900 text-white":"completed"===e.status?"bg-lime-900/30 text-gray-200":"bg-gray-700 text-gray-200 hover:bg-gray-600"}`,"data-taskid":i,onClick:()=>{console.log("Task clicked with ID:",i),i?s(i):console.error("Cannot set task as active: No task ID found")},children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[a.jsx("span",{className:"font-medium",children:e.title}),e.finalEstimate&&a.jsx("span",{className:"rounded-full bg-lime-800 px-2 py-1 text-xs",children:e.finalEstimate})]}),a.jsx("div",{className:"mt-1 text-xs",children:a.jsx("span",{className:`rounded px-1.5 py-0.5 ${"active"===e.status?"bg-primary-700":"completed"===e.status?"bg-lime-700":"bg-gray-600"}`,children:e.status.charAt(0).toUpperCase()+e.status.slice(1)})})]},i)):(console.error("Task missing ID:",e),null)})}))}function JiraIntegration({sessionId:e,socket:t}){let[s,n]=(0,i.useState)(""),[r,o]=(0,i.useState)(!1),[l,d]=(0,i.useState)(""),handleImport=async a=>{if(a.preventDefault(),!s.trim()){d("Project key is required");return}o(!0),d("");try{let a=await fetch("/api/jira/import",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sessionId:e,projectKey:s})}),i=await a.json();if(!a.ok)throw Error(i.message||"Failed to import from JIRA");n(""),t&&t.emit("refresh_session",{sessionId:e})}catch(e){d(e instanceof Error?e.message:"An error occurred")}finally{o(!1)}};return(0,a.jsxs)("div",{children:[l&&a.jsx("div",{className:"mb-3 rounded-md bg-red-800/50 p-2 text-sm text-white",children:l}),(0,a.jsxs)("form",{onSubmit:handleImport,children:[(0,a.jsxs)("div",{className:"mb-3",children:[a.jsx("label",{htmlFor:"jiraProjectKey",className:"mb-1 block text-sm font-medium text-gray-300",children:"JIRA Project Key"}),a.jsx("input",{type:"text",id:"jiraProjectKey",className:"w-full rounded-md bg-gray-700 px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-blue-500",value:s,onChange:e=>n(e.target.value),placeholder:"e.g. PROJ",required:!0})]}),a.jsx("button",{type:"submit",className:`w-full rounded-md bg-primary-700 py-2 text-sm font-medium text-white hover:bg-primary-600 ${r?"opacity-70":""}`,disabled:r,children:r?"Importing...":"Import Tasks from JIRA"})]}),a.jsx("p",{className:"mt-2 text-xs text-gray-400",children:"This will import open issues from the specified JIRA project."})]})}function ShareSession({sessionId:e,shareLink:t}){let[s,n]=(0,i.useState)(!1),r=`/sessions/join?code=${t||e}`,copyToClipboard=async()=>{try{await navigator.clipboard.writeText(r),n(!0),setTimeout(()=>n(!1),2e3)}catch(e){console.error("Failed to copy: ",e)}};return a.jsx("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center",children:(0,a.jsxs)("div",{className:"relative flex w-full max-w-md items-center rounded-md bg-gray-700 px-3 py-2",children:[a.jsx("input",{type:"text",value:r,readOnly:!0,className:"w-full bg-transparent text-sm text-gray-300 focus:outline-none"}),a.jsx("button",{onClick:copyToClipboard,className:"ml-2 rounded-md bg-primary-800 px-3 py-1 text-sm font-medium text-white hover:bg-primary-700",children:s?"Copied!":"Copy"})]})})}function AddTask({sessionId:e,socket:t}){let[s,n]=(0,i.useState)(!1),[r,o]=(0,i.useState)(""),[l,d]=(0,i.useState)(""),[c,m]=(0,i.useState)(""),[u,g]=(0,i.useState)(!1),[p,h]=(0,i.useState)("idle"),[x,f]=(0,i.useState)("");(0,i.useEffect)(()=>{if(!t)return;let onAddTaskReceived=e=>{console.log("Server acknowledged task receipt:",e)},onAddTaskSuccess=e=>{console.log("Task added successfully:",e),h("success"),g(!1),o(""),d(""),m(""),n(!1)},onAddTaskError=e=>{console.error("Error adding task:",e.error),f(e.error||"Failed to add task"),h("error"),g(!1)};return t.on("add_task_received",onAddTaskReceived),t.on("add_task_success",onAddTaskSuccess),t.on("add_task_error",onAddTaskError),()=>{t.off("add_task_received",onAddTaskReceived),t.off("add_task_success",onAddTaskSuccess),t.off("add_task_error",onAddTaskError)}},[t]);let handleSubmit=s=>{if(s.preventDefault(),r.trim()){if(g(!0),h("submitting"),f(""),console.log("Attempting to add task:",{sessionId:e,socket:!!t}),t){if(!t.connected){console.error("Socket is disconnected, attempting to reconnect..."),f("Socket disconnected. Attempting to reconnect..."),t.connect(),t.once("connect",()=>{console.log("Socket reconnected, retrying submission"),f(""),handleSubmit(s)}),setTimeout(()=>{t.connected||(f("Could not reconnect to server. Please try again later."),h("error"),g(!1))},5e3);return}let e={title:r,description:l,jiraId:c||void 0};console.log("Emitting add_task event with data:",e);let a=!1,i=setTimeout(()=>{a=!0,f("Server response timeout - the task may have been created but the response was slow. Please check before creating another task."),h("error"),g(!1)},1e4);try{t.emit("add_task",e);let disconnectHandler=e=>{console.error("Socket disconnected during task creation:",e),a||(clearTimeout(i),f(`Connection lost while creating task: ${e}. The task may still have been created.`),h("error"),g(!1))};t.once("disconnect",disconnectHandler),t.once("add_task_success",()=>{t.off("disconnect",disconnectHandler)}),t.once("add_task_error",()=>{t.off("disconnect",disconnectHandler)})}catch(e){console.error("Error emitting add_task event:",e),f("Failed to send task to server"),h("error"),g(!1),clearTimeout(i)}}else console.error("Socket not available for adding task"),f("Socket connection not available"),h("error"),g(!1)}};return s?(0,a.jsxs)("form",{onSubmit:handleSubmit,className:"mt-4 border-t border-gray-700 pt-4",children:[(0,a.jsxs)("div",{className:"mb-3",children:[a.jsx("label",{htmlFor:"taskTitle",className:"mb-1 block text-sm font-medium text-gray-300",children:"Task Title"}),a.jsx("input",{type:"text",id:"taskTitle",className:"w-full rounded-md bg-gray-700 px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-blue-500",value:r,onChange:e=>o(e.target.value),required:!0,disabled:u})]}),(0,a.jsxs)("div",{className:"mb-3",children:[a.jsx("label",{htmlFor:"taskDescription",className:"mb-1 block text-sm font-medium text-gray-300",children:"Description (Optional)"}),a.jsx("textarea",{id:"taskDescription",className:"w-full rounded-md bg-gray-700 px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-blue-500",value:l,onChange:e=>d(e.target.value),rows:2,disabled:u})]}),(0,a.jsxs)("div",{className:"mb-4",children:[a.jsx("label",{htmlFor:"jiraId",className:"mb-1 block text-sm font-medium text-gray-300",children:"JIRA ID (Optional)"}),a.jsx("input",{type:"text",id:"jiraId",className:"w-full rounded-md bg-gray-700 px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-blue-500",value:c,onChange:e=>m(e.target.value),placeholder:"e.g. PROJ-123",disabled:u})]}),x&&a.jsx("div",{className:"mb-4 rounded-md bg-red-900 p-2 text-sm text-white",children:x}),(0,a.jsxs)("div",{className:"flex gap-2",children:[a.jsx("button",{type:"submit",className:`flex-1 rounded-md ${u?"bg-gray-600 cursor-not-allowed":"bg-primary-700 hover:bg-primary-600"} py-2 text-sm font-medium text-white`,disabled:u,children:u?"Adding...":"Add Task"}),a.jsx("button",{type:"button",onClick:()=>n(!1),className:"rounded-md bg-gray-600 px-3 py-2 text-sm text-white hover:bg-gray-500",disabled:u,children:"Cancel"})]})]}):a.jsx("div",{className:"mt-4 border-t border-gray-700 pt-4",children:a.jsx("button",{onClick:()=>{n(!0),h("idle"),f("")},className:"w-full rounded-md bg-primary-800 px-3 py-2 text-center text-sm font-medium text-white hover:bg-primary-700",children:"Add New Task"})})}var d=s(25513),c=s(49717),m=s(75149);function ParticipantsList({socket:e,activeTaskId:t,sessionData:s,isAdmin:n}){let[o,l]=(0,i.useState)([]),[d,u]=(0,i.useState)(new Set),{data:g}=(0,r.useSession)();(0,i.useEffect)(()=>{if(!e)return;let handleParticipantsUpdate=e=>{console.log("Received participants update:",e),l(e)},handleUserEstimated=e=>{e.taskId===t&&(console.log("User estimated:",e.userId),u(t=>{let s=new Set(t);return s.add(e.userId),s}))},handleEstimatesRevealed=()=>{u(new Set)},handleEstimatesHidden=()=>{u(new Set)},handleUserJoined=e=>{console.log("User joined:",e.userId)},handleUserLeft=e=>{console.log("User left:",e.userId)},handleSessionUpdate=e=>{if(t&&e.tasks){let s=e.tasks.find(e=>e.id===t||e._id===t||e._id.toString()===t);if(s){let e=new Set(s.estimates.map(e=>String(e.userId)));u(e)}}};return e.on("participants_update",handleParticipantsUpdate),e.on("user_estimated",handleUserEstimated),e.on("estimates_revealed",handleEstimatesRevealed),e.on("estimates_hidden",handleEstimatesHidden),e.on("user_joined",handleUserJoined),e.on("user_left",handleUserLeft),e.on("session_update",handleSessionUpdate),()=>{e.off("participants_update",handleParticipantsUpdate),e.off("user_estimated",handleUserEstimated),e.off("estimates_revealed",handleEstimatesRevealed),e.off("estimates_hidden",handleEstimatesHidden),e.off("user_joined",handleUserJoined),e.off("user_left",handleUserLeft),e.off("session_update",handleSessionUpdate)}},[e,t]),(0,i.useEffect)(()=>{u(new Set)},[t]);let handleMakeAdmin=t=>{e&&s?._id&&e.emit("make_admin",{targetUserId:t})},handleRemoveAdmin=t=>{e&&s?._id&&e.emit("remove_admin",{targetUserId:t})};return 0===o.length?null:(0,a.jsxs)("div",{className:"rounded-lg bg-gray-800 p-4 shadow-md mb-6",children:[(0,a.jsxs)("h2",{className:"mb-4 text-xl font-bold text-white",children:["Participants (",o.length,")"]}),a.jsx("div",{className:"space-y-2",children:o.map(e=>{let i=g?.user,r=i?.id||i?.email,o=s?.admins?.includes(e.userId),l=s?.ownerId===e.userId,u=n&&r!==e.userId&&!l;return(0,a.jsxs)("div",{className:`flex items-center justify-between rounded-md p-2 ${e.connected?"bg-gray-700":"bg-gray-800 opacity-50"}`,children:[(0,a.jsxs)("div",{className:"flex items-center",children:[a.jsx("div",{className:`mr-2 h-3 w-3 rounded-full ${e.connected?"bg-lime-500":"bg-red-500"}`}),a.jsx("span",{className:"text-sm text-white",children:e.username}),l&&a.jsx("span",{className:"ml-2 text-xs bg-gray-600 text-white px-2 py-0.5 rounded",children:"Owner"}),o&&!l&&a.jsx("span",{className:"ml-2 text-xs bg-blue-600 text-white px-2 py-0.5 rounded",children:"Admin"})]}),(0,a.jsxs)("div",{className:"flex items-center",children:[u&&a.jsx("button",{onClick:()=>o?handleRemoveAdmin(e.userId):handleMakeAdmin(e.userId),className:`mr-2 p-1.5 text-xs rounded ${o?"bg-red-600 text-white hover:bg-red-700":"bg-blue-600 text-white hover:bg-blue-700"}`,title:o?"Remove Admin":"Make Admin",children:o?a.jsx(c.Z,{className:"h-4 w-4"}):a.jsx(m.Z,{className:"h-4 w-4"})}),t&&a.jsx("div",{className:`mr-2 h-5 w-5 rounded-full ${d.has(e.userId)?"bg-primary-500":"bg-gray-600"}`,title:d.has(e.userId)?"Has estimated":"Hasn't estimated yet"})]})]},e.userId)})})]})}function RevealEstimates({socket:e,activeTaskId:t,isAdmin:s,activeTask:n}){let[r,o]=(0,i.useState)(!1),[l,d]=(0,i.useState)(!1),[c,m]=(0,i.useState)(!1);return((0,i.useEffect)(()=>{if(!e||!t)return;o(!1),n?m("completed"===n.status||void 0!==n.finalEstimate):m(!1);let handleSessionUpdate=e=>{if(!t||!e.tasks)return;let s=e.tasks.find(e=>e.id===t||e._id===t||e._id.toString()===t);s&&(o(!!s.revealed),m("completed"===s.status||void 0!==s.finalEstimate))},handleEstimatesRevealed=e=>{e.taskId===t&&(o(!0),d(!1))},handleEstimatesHidden=e=>{e.taskId===t&&(o(!1),d(!1))},handleTaskCompleted=e=>{e.taskId===t&&(m(!0),o(!0))};return e.on("session_update",handleSessionUpdate),e.on("estimates_revealed",handleEstimatesRevealed),e.on("estimates_hidden",handleEstimatesHidden),e.on("task_completed",handleTaskCompleted),()=>{e.off("session_update",handleSessionUpdate),e.off("estimates_revealed",handleEstimatesRevealed),e.off("estimates_hidden",handleEstimatesHidden),e.off("task_completed",handleTaskCompleted)}},[e,t,n]),s&&t)?c?a.jsx("div",{className:"mt-4 p-2 text-sm text-center rounded-md bg-lime-900 text-white",children:"Task completed with final estimate"}):a.jsx("button",{onClick:()=>{e&&t&&s&&!l&&!c&&(d(!0),console.log(`${r?"Hiding":"Revealing"} estimates for task ${t}`),e.emit(r?"hide_estimates":"reveal_estimates",{taskId:t}))},disabled:l||c,className:`mt-4 w-full rounded-md px-4 py-2 font-medium text-white transition-colors ${l||c?"bg-gray-600 cursor-not-allowed":r?"bg-red-700 hover:bg-red-600":"bg-lime-700 hover:bg-lime-500"}`,children:l?"Processing...":r?"Hide Estimates":"Reveal Estimates"}):null}function Loading({text:e="Loading...",size:t="md",fullScreen:s=!1}){return a.jsx("div",{className:s?"fixed inset-0 flex items-center justify-center bg-gray-900/50 backdrop-blur-sm":"flex items-center justify-center p-4",children:(0,a.jsxs)("div",{className:"flex flex-col items-center gap-3",children:[(0,a.jsxs)("div",{className:`relative ${{sm:"h-4 w-4",md:"h-8 w-8",lg:"h-12 w-12"}[t]}`,children:[a.jsx("div",{className:"absolute inset-0 animate-ping rounded-full bg-primary-400/30"}),a.jsx("div",{className:"relative rounded-full bg-primary-500"})]}),e&&a.jsx("span",{className:"text-sm font-medium text-gray-300 animate-pulse",children:e})]})})}function SessionPage(){let e=(0,n.useParams)(),t=e?.id,{data:s,status:c}=(0,r.useSession)(),{width:m,height:u}=function(){let[e,t]=(0,i.useState)({width:0,height:0});return(0,i.useEffect)(()=>{function handleResize(){t({width:window.innerWidth,height:window.innerHeight})}return window.addEventListener("resize",handleResize),handleResize(),()=>window.removeEventListener("resize",handleResize)},[]),e}(),[g,p]=(0,i.useState)(null),[h,x]=(0,i.useState)(null),[f,v]=(0,i.useState)(null),[k,b]=(0,i.useState)(!0),[y,j]=(0,i.useState)(""),[_,w]=(0,i.useState)(null),[N,S]=(0,i.useState)(!1),[I,E]=(0,i.useState)(new Map),[T,A]=(0,i.useState)(!1),C=["?","0","1","2","3","5","8","13","21","34","∞"],P=["?","XS","S","M","L","XL","XXL","∞"],getTaskId=e=>{if(e)return e.id||e._id?.toString()};(0,i.useEffect)(()=>{if("unauthenticated"===c){window.location.href=`/auth/signin?callbackUrl=/sessions/${t}`;return}"authenticated"===c&&t&&(b(!0),fetch(`/api/sessions/${t}`).then(e=>{if(!e.ok)throw Error("Failed to fetch session");return e.json()}).then(e=>{console.log("Fetched session data:",{id:e._id,taskCount:e.tasks.length,tasks:e.tasks.map(e=>({id:e.id||e._id,title:e.title,status:e.status}))}),p(e);let t=e.tasks.find(e=>"active"===e.status);t?console.log("Found active task:",{id:getTaskId(t),title:t.title}):console.log("No active task found in session data"),x(t||null)}).catch(e=>{j(e.message||"An error occurred")}).finally(()=>{b(!1)}))},[t,c]),(0,i.useEffect)(()=>{if(g&&s)try{let e=s.user.id||("test@example.com"===s.user.email?"test-user-1":"unknown-user");console.log("Using userId for socket:",e);let t=(0,o.ZP)({path:"/api/socketio",query:{sessionId:g._id,userId:e,username:s.user.name||s.user.email},transports:["polling"],reconnectionAttempts:10,reconnectionDelay:1e3,timeout:2e4,forceNew:!0});return t.on("connect",()=>{console.log("Connected to socket server successfully"),t.emit("ping",{message:"Client connected"}),t.emit("refresh_session")}),t.on("connect_error",e=>{console.error("Socket connection error:",e.message,e),setTimeout(()=>{console.log("Attempting to reconnect socket..."),t.connect()},3e3)}),t.on("set_active_task_received",e=>{console.log("Server acknowledged set_active_task:",e)}),t.on("set_active_task_success",e=>{console.log("Task set as active successfully:",e)}),t.on("set_active_task_error",e=>{console.error("Error setting task as active:",e.error)}),t.on("session_update",t=>{if(console.log("Received session update",{taskCount:t.tasks.length,hasActiveTask:t.tasks.some(e=>"active"===e.status),taskStates:t.tasks.map(e=>({id:e.id||e._id?.toString(),title:e.title,status:e.status,estimates:e.estimates?.length||0,revealed:e.revealed})),estimateCount:t.tasks.find(e=>"active"===e.status)?.estimates?.length||0}),g){let s=JSON.parse(JSON.stringify(t));g.tasks.forEach(e=>{let t=e.id||e._id?.toString(),a=s.tasks.find(e=>e.id===t||e._id?.toString()===t);a&&e.status!==a.status&&(console.log(`Task status transition: "${a.title}" ${e.status} -> ${a.status}`),"pending"===e.status&&"completed"===a.status&&(console.warn(`Preventing incorrect transition from pending to completed for task: ${a.title}`),a.status="pending"))}),g.tasks.forEach(e=>{let t=e.id||e._id?.toString();if(!0===e.revealed&&t){let a=s.tasks.find(e=>e.id===t||e._id?.toString()===t);if(a&&(console.log(`Preserving revealed=true for task ${t}`),a.revealed=!0,e.estimates&&e.estimates.length>0)){console.log(`Preserving ${e.estimates.length} estimates for task ${t}`);let s=new Map;e.estimates.forEach(e=>{let t=e.userId?.toString();t&&s.set(t,e)}),a.estimates=a.estimates.map(e=>{let t=e.userId?.toString(),a=s.get(t);return a&&void 0!==a.value&&null!==a.value?{...e,value:a.value,hasEstimate:!0}:e})}}}),p(s);let a=s.tasks.find(e=>"active"===e.status);if(a){console.log("Active task found:",a.title,"with",a.estimates?.length||0,"estimates");let t=a.estimates?.find(t=>t.userId===e||"test-user-1"===t.userId);t?(console.log("User already estimated with:",t.value),v(t.value)):v(null),x(a),checkConsensus(a,s.participants.length)}else console.log("No active task found in updated session"),v(null),x(null)}else{p(t);let s=t.tasks.find(e=>"active"===e.status);if(s){console.log("Active task found:",s.title,"with",s.estimates?.length||0,"estimates");let a=s.estimates?.find(t=>t.userId===e||"test-user-1"===t.userId);a?(console.log("User already estimated with:",a.value),v(a.value)):v(null),x(s),checkConsensus(s,t.participants.length)}else console.log("No active task found in updated session"),v(null),x(null)}}),t.on("estimates_revealed",e=>{if(console.log("Estimates revealed for task:",e.taskId,e.estimates),g){let t=JSON.parse(JSON.stringify(g)),s=t.tasks.find(t=>t.id===e.taskId||t._id?.toString()===e.taskId);s&&(s.revealed=!0,e.estimates&&Array.isArray(e.estimates)&&(console.log("Updating estimates data with:",e.estimates),s.estimates=e.estimates.map(e=>({userId:e.userId,value:e.value,hasEstimate:!0}))),p(t),h&&(h.id===e.taskId||h._id?.toString()===e.taskId)&&(console.log("Updating active task with revealed estimates"),x({...h,revealed:!0,estimates:s.estimates})))}}),t.on("estimates_hidden",t=>{if(console.log("Estimates hidden for task:",t.taskId),g){let s={...g},a=s.tasks.find(e=>e.id===t.taskId||e._id?.toString()===t.taskId);if(a&&(a.revealed=!1,a.estimates=a.estimates.map(t=>{let s=t.userId===e||"test-user-1"===t.userId,a=void 0!==t.value&&null!==t.value;return{userId:t.userId,hasEstimate:a,value:s&&a?t.value:"-"}}),p(s),h&&(h.id===t.taskId||h._id?.toString()===t.taskId))){let e={...h,revealed:!1,estimates:a.estimates};x(e)}}}),t.on("task_completed",e=>{if(console.log("Task completed:",e.taskId,"with final estimate:",e.finalEstimate),g){let s=JSON.parse(JSON.stringify(g)),a=s.tasks.find(t=>t.id===e.taskId||t._id?.toString()===e.taskId);if(a){a.status="completed",a.finalEstimate=e.finalEstimate,a.revealed=!0,console.log("Updated session data:",s);let i=s.tasks.every(e=>"completed"===e.status);if(i)console.log("All tasks completed, marking session as completed"),s.status="completed";else{let e=s.tasks.find(e=>"pending"===e.status);if(e&&(console.log(`Setting next task as active: ${e.title}`),e.status="active",t&&T)){let s=e.id||e._id?.toString();s&&(console.log(`Emitting set_active_task for next task: ${s}`),setTimeout(()=>{t.emit("set_active_task",{taskId:s})},100))}}p(s),h&&(h.id===e.taskId||h._id?.toString()===e.taskId)&&x({...h,status:"completed",finalEstimate:e.finalEstimate,revealed:!0})}}}),t.on("disconnect",e=>{console.log("Disconnected from socket server. Reason:",e)}),t.on("participants_update",e=>{console.log("Received participants update:",e);let t=new Map;e.forEach(e=>{t.set(e.userId,e)}),E(t)}),t.on("error",e=>{console.error("Socket error:",e)}),w(t),()=>{console.log("Cleaning up socket connection"),t.off("connect"),t.off("connect_error"),t.off("set_active_task_received"),t.off("set_active_task_success"),t.off("set_active_task_error"),t.off("session_update"),t.off("estimates_revealed"),t.off("estimates_hidden"),t.off("task_completed"),t.off("disconnect"),t.off("participants_update"),t.off("error"),t.disconnect()}}catch(e){console.error("Error setting up socket:",e)}},[g?._id,s]),(0,i.useEffect)(()=>{let checkAdminStatus=async()=>{if(e?.id)try{let t=await fetch(`/api/sessions/${e.id}/admins`),a=await t.json();if(a.admins){let e=s?.user,t=e?.id||e?.email;A(a.ownerId===t||a.admins.some(e=>e===t))}}catch(e){console.error("Failed to check admin status:",e)}};s?.user&&checkAdminStatus()},[s,e?.id]);let submitEstimate=e=>{let t=s?.user?.id||(s?.user?.email==="test@example.com"?"test-user-1":null),a=getTaskId(h);if(console.log("Attempting to submit estimate:",{value:e,activeTaskId:a,userId:t,hasSocket:!!_}),!h||!a||!t){console.error("Cannot submit estimate: No active task or user ID");return}if(v(e),_)try{let t={taskId:a,value:e};console.log("Emitting submit_estimate event with data:",t),_.emit("submit_estimate",t),_.once("error",e=>{console.error("Socket error after estimate submission:",e)}),_.emit("ping",{message:"Submitted estimate"})}catch(e){console.error("Error submitting estimate:",e)}else console.error("Socket not connected, cannot submit estimate")},checkConsensus=(e,t)=>{if(!e||e.estimates.length<t)return;let s=new Set(e.estimates.map(e=>e.value));1===s.size&&e.estimates.length>=2&&(S(!0),setTimeout(()=>S(!1),5e3))},emitSetActiveTask=e=>{console.log("Emitting set_active_task event");try{let t={taskId:e,preservePreviousStatus:!0};console.log("Emitting with payload:",t),_.emit("set_active_task",t),_.emit("ping",{message:"After setting task"})}catch(e){console.error("Error emitting set_active_task:",e)}},setFinalEstimate=(e,t)=>{T&&_&&_.emit("set_final_estimate",{taskId:e,estimate:t})},getUsernameForEstimate=e=>{let t=I.get(e);return t?.username?t.username:e===s?.user?.id?s.user.name||"You":`User ${e.slice(0,6)}`};return((0,i.useEffect)(()=>{h&&console.log("Active task state updated:",{id:getTaskId(h),title:h.title,revealed:h.revealed,estimateCount:h.estimates.length,estimates:h.estimates.map(e=>({userId:e.userId,value:e.value,hasEstimate:e.hasEstimate}))})},[h]),k)?a.jsx(Loading,{fullScreen:!0}):y?a.jsx("div",{className:"flex min-h-screen items-center justify-center",children:(0,a.jsxs)("div",{className:"text-center",children:[a.jsx("h2",{className:"mb-4 text-2xl font-bold text-red-500",children:"Error"}),a.jsx("p",{className:"text-white",children:y})]})}):(0,a.jsxs)(a.Fragment,{children:[N&&a.jsx(d.Z,{width:m,height:u}),a.jsx(l.Z,{}),a.jsx("main",{className:"container mx-auto px-4 py-8",children:g&&(0,a.jsxs)("div",{className:"mb-8",children:[(0,a.jsxs)("div",{className:"mb-6 flex flex-col justify-between gap-4 sm:flex-row sm:items-center",children:[a.jsx("h1",{className:"text-3xl font-bold text-white",children:g.name}),a.jsx(ShareSession,{sessionId:t,shareLink:g.shareLink})]}),(0,a.jsxs)("div",{className:"grid grid-cols-1 gap-8 lg:grid-cols-4",children:[(0,a.jsxs)("div",{className:"lg:col-span-1",children:[a.jsx(ParticipantsList,{socket:_,activeTaskId:getTaskId(h)||null,sessionData:g,isAdmin:T}),(0,a.jsxs)("div",{className:"rounded-lg bg-gray-800 p-4 shadow-md",children:[a.jsx("h2",{className:"mb-4 text-xl font-bold text-white",children:"Tasks"}),a.jsx(TaskList,{tasks:g.tasks,activeTaskId:getTaskId(h),setActiveTask:e=>{if(console.log("RAW taskId:",e,typeof e),console.log("Attempting to set task as active:",e,{isAdmin:T,hasSocket:!!_,userId:s?.user?.id||s?.user?.email,socketConnected:_?.connected}),!e){console.error("Cannot set task as active: Invalid task ID");return}let t=s?.user?.email==="test@example.com";if(!T&&!t||!_){console.warn("Cannot set task as active: user is not admin or socket not connected");return}if(!_.connected){console.error("Socket is not connected. Attempting to reconnect..."),_.connect(),_.once("connect",()=>{console.log("Socket reconnected, now emitting set_active_task event"),emitSetActiveTask(e)});return}emitSetActiveTask(e)},isAdmin:!!T}),T&&a.jsx(AddTask,{sessionId:g._id,socket:_})]}),T&&(0,a.jsxs)("div",{className:"mt-6 rounded-lg bg-gray-800 p-4 shadow-md",children:[a.jsx("h2",{className:"mb-4 text-xl font-bold text-white",children:"JIRA Integration"}),a.jsx(JiraIntegration,{sessionId:g._id,socket:_})]})]}),a.jsx("div",{className:"lg:col-span-3",children:h?(0,a.jsxs)("div",{className:"rounded-lg bg-gray-800 p-6 shadow-md",children:[(0,a.jsxs)("div",{className:"mb-6",children:[a.jsx("h3",{className:"text-2xl font-bold text-white",children:h.title}),h.description&&a.jsx("p",{className:"mt-2 text-gray-300",children:h.description}),h.jiraId&&(0,a.jsxs)("div",{className:"mt-2 rounded-md bg-primary-900 p-2 text-sm",children:[a.jsx("span",{className:"font-semibold",children:"JIRA ID:"})," ",h.jiraId]})]}),(0,a.jsxs)("div",{className:"mb-6",children:[a.jsx("h4",{className:"mb-2 text-lg font-semibold text-white",children:"Estimation"}),a.jsx("div",{className:"flex flex-wrap gap-3",children:("fibonacci"===g.estimationType?C:P).map(e=>a.jsx(EstimationCard,{value:e,selected:f===e,onClick:()=>submitEstimate(e)},e))})]}),(0,a.jsxs)("div",{className:"mb-6 mt-6",children:[a.jsx("h4",{className:"mb-3 text-lg font-semibold text-white",children:"Team Estimates"}),h.finalEstimate&&a.jsx("div",{className:"mb-4 p-3 rounded-md bg-lime-800 text-white",children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{children:[a.jsx("span",{className:"font-semibold",children:"Final Estimate:"})," ",h.finalEstimate]}),a.jsx("div",{className:"text-sm bg-lime-700 rounded-md px-2 py-1",children:"Completed"})]})}),a.jsx("div",{className:"space-y-2",children:h.estimates.length>0?(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-4 sm:grid-cols-3 md:grid-cols-4",children:[h.estimates.map(e=>(0,a.jsxs)("div",{className:`rounded-md p-3 text-center transition-colors ${h.revealed?"bg-lime-700":e.hasEstimate||void 0!==e.value?"bg-primary-700":"bg-gray-700"}`,children:[a.jsx("div",{className:"font-medium text-white",children:getUsernameForEstimate(e.userId)}),a.jsx("div",{className:"mt-1 text-xl font-bold text-white",children:h.revealed?null!==e.value&&void 0!==e.value?e.value.toString():"-":e.hasEstimate||void 0!==e.value?"?":"-"})]},e.userId)),h.aiEstimate&&(0,a.jsxs)("div",{className:"rounded-md bg-primary-900 p-3 text-center",children:[a.jsx("div",{className:"font-medium text-white",children:"AI Suggestion"}),a.jsx("div",{className:"mt-1 text-xl font-bold text-green-400",children:h.aiEstimate})]})]}):a.jsx("p",{className:"text-gray-400",children:"No estimates yet. Be the first to estimate!"})})]}),T&&(0,a.jsxs)("div",{className:"border-t border-gray-700 pt-4",children:[a.jsx("h4",{className:"mb-2 text-lg font-semibold text-white",children:"Admin Tools"}),a.jsx(RevealEstimates,{socket:_,activeTaskId:getTaskId(h)||null,isAdmin:!!T,activeTask:h}),h.estimates.length>0&&h.revealed&&"completed"!==h.status&&!h.finalEstimate&&(0,a.jsxs)("div",{className:"flex flex-wrap gap-2 mt-4",children:[a.jsx("div",{className:"mr-2 text-gray-300",children:"Set final estimate:"}),("fibonacci"===g.estimationType?C:P).map(e=>a.jsx("button",{onClick:()=>setFinalEstimate(getTaskId(h)||"",e),className:`rounded-md px-3 py-1 text-sm ${h.finalEstimate===e?"bg-lime-700 text-white":"bg-gray-700 text-gray-200 hover:bg-gray-600"}`,children:e},`final-${e}`))]})]})]}):a.jsx("div",{className:"flex h-64 items-center justify-center rounded-lg bg-gray-800 p-6 shadow-md",children:a.jsx("p",{className:"text-center text-lg text-gray-400",children:"Select a task to start estimation"})})})]})]})})]})}},71046:(e,t,s)=>{"use strict";s.r(t),s.d(t,{$$typeof:()=>r,__esModule:()=>n,default:()=>l});var a=s(95153);let i=(0,a.createProxy)(String.raw`/Users/hector.jaraba/Proyects/cursor-planning-poker/src/app/sessions/[id]/page.tsx`),{__esModule:n,$$typeof:r}=i,o=i.default,l=o}};var t=require("../../../webpack-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),s=t.X(0,[657,930,440,451,178,726,641],()=>__webpack_exec__(54939));module.exports=s})();